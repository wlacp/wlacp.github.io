---
layout: default
title: 记一次 elasticsearch 升级
---
# {{ page.title }}
{{ page.date | date_to_string }}
<!-- 
## 背景

最近在做私有化部署项目时，由于该项目涉及多个子系统，为避免客户维护多个版本的中间件，所以需要统一中间件的版本，elasticsearch（以下简称es）就是其中之一，项目需要将 es 升级到 6.x，我所负责的子系统由于之前使用的是 2.1.2 版本的集群，因为两个主要版本升级（2.x到5.x到6.x），导致无法直接迁移数据，踩了不少的坑，因此将升级迁移过程做了以下总结，希望给需要的同学提供一点帮助。

## 升级集群

事实上，升级集群并不需要我们做什么，因为我们采用的方式是新建一个高版本集群，而且集群部署是运维同学负责的，我们只需要提供集群的大致配置即可。

## 数据迁移

由于原集群是应用于线上业务，里面已经有了生产数据，所以只升级集群是不够的，我们还需要迁移数据。而运维同学暂时不支持数据迁移服务，需要我们自己迁移。那么问题来了，如何把 2.x 的数据迁移到 6.x 呢，下面跟大家聊一下我的数据迁移之路。

运维同学提供了两个方案，重新灌数据和从原集群读取数据写入新集群，灌数据于我们并不适用，因为业务数据并不是固定的。然后就是读取数据写入新集群，这种方法因为需要写代码，这样就需要时间了，然后我就想有没有其他办法实现呢？

升级迁移数据，这是一个经常会遇到的场景，并不是一个特殊需求，普遍需要的东西，用户量也会很大，也就会有相应的方案或工具产生以提高效率。于是，我便上网搜索，网上提到了很多的工具，[Elasticsearch史上最全最常用工具清单](https://www.itcodemonkey.com/article/5265.html)、[ElasticSearch集群迁移和升级总结](http://tech.lede.com/2017/10/24/rd/server/ElasticSearch_migration_upgrade/) 等文章都多次提到了比较常用的三个工具Elasticsearch-migration、Elasticsearch-Exporter 和 Elasticsearch-dump，然而，看过这些工具的介绍才发现，这些工具近来没怎么更新，也许已经趋于稳定，但是并不支持直接从 2.x 将数据迁移到 6.x。如果有同学的需求只是升级到 5.x 可以尝试使用这几个工具。

已有工具不能用，再想其他办法。官方总是比其他人的文章值得信任，毕竟现在网上很多文章都是不验证就直接转载，很多时候照着网友的总结做了很久结果发现是有问题的，这时候就很郁闷了，所以先去官方看看有没有相应的方法。
[官方论坛提供的方案](https://discuss.elastic.co/t/migration-from-es2-1-to-es6-4/152600)，该方案是 es 团队成员提供的，里面提到了两种方法，
- 先升级到最新的 5.x版本，在 5.x 正常运行后，从 5.x 升级到 6.x；
- 并行运行两个集群，将索引逐个切换到新集群。

第一个方法由于我们升级方式是新建集群，所以不适用，第二个方法使用双写方式，业务数据同时写入两个集群，考虑到索引过期时间，该方案周期相对较长，打算先试试其他办法。

回到了最初运维的方案，读取原集群数据写入新集群，虽然有一定工作量，但是感觉应该不需要太久。说干就干，然而是我估计太乐观，程序写好了，也跑起来了，一部分数据已经写入了新集群，突然 `no alive nodes found in your cluster`，这是个什么情况，看看页面工具，可以查询，怎么就在程序里不行里呢，查了好久没有找到解决方案，已经耗时两天了，而这个迁移工具对目前来说也就用于两个地方，考虑到投入产出比，再加上经过沟通，使用双写方案虽然周期较长但也勉强可以接受，所以最终决定使用双写方案，自己实现工具的方法夭折了。后来用了 go 的官方库，发现一个 close 方法，考虑可能是连接过于频繁导致的。

虽然最终选择了双写方案，但是这个方案感觉并不好，所以我也没有放弃，业余时间我依旧在找其他办法，在我搜索的过程中，我发现了一个词经常出现，`reindex`，后来突然想着在官方文档里搜一下这个词，然后我就发现了[使用远程的 reindex 可以将 5.6 之前的集群迁移到 6.x 而不会中断服务](https://www.elastic.co/guide/en/elasticsearch/reference/current/reindex-upgrade-remote.html)，这个方法需要修改集群配置，即在`elasticsearch.yml` 将原集群加入白名单，由于运维不支持修改配置，所以暂时没有尝试。

## 总结

这是一次 es 升级实践的经验，这也是一次解决问题步骤的分析，这也是寻找更优方案的努力。虽然我尝试的方案失败了，但也许你有其他的思路或想法，欢迎一起讨论。
 -->
